<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <title>TaxBuddy AI Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* ========================================================= */
        /* ROOT VARIABLES */
        /* ========================================================= */
        :root {
            --primary: #7b61ff;
            --primary-soft: rgba(123, 97, 255, 0.25);
            --avatar-blue: #4da3ff;
            --glass-light: rgba(255, 255, 255, 0.55);
            --glass-dark: rgba(0, 0, 0, 0.55);
            --bubble-light: rgba(255, 255, 255, 0.45);
            --bubble-dark: rgba(0, 0, 0, 0.45);
            --border-light: rgba(255, 255, 255, 0.3);
            --border-dark: rgba(255, 255, 255, 0.15);
        }

        /* ========================================================= */
        /* BASE PAGE STYLE */
        /* ========================================================= */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #111;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="dots" x="0" y="0" width="80" height="80" patternUnits="userSpaceOnUse"><circle cx="40" cy="40" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="1200" height="800" fill="url(%23dots)"/></svg>');
            background-attachment: fixed;
            background-size: cover, auto;
        }

        body[data-theme="dark"] {
            color: white;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="1200" height="800" fill="url(%23grid)"/></svg>');
            background-attachment: fixed;
            background-size: cover, auto;
        }

        /* ========================================================= */
        /* SIDEBAR (LEFT) */
        /* ========================================================= */
        .sidebar {
            width: 270px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-brand {
            display: flex;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
            align-items: center;
            color: white;
        }

        .sidebar-brand-icon {
            background: var(--primary);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .menu-item,
        .chat-item {
            padding: 12px 14px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .menu-item:hover,
        .chat-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(4px);
        }

        .menu-item b {
            display: block;
            margin-bottom: 4px;
        }

        .menu-item small,
        .chat-item small {
            opacity: 0.7;
            font-size: 12px;
        }

        .sidebar-section-title {
            margin-top: 24px;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chats-container {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-item-content {
            flex: 1;
            cursor: pointer;
        }

        .chat-item-title {
            font-weight: 500;
            font-size: 13px;
        }

        .chat-item-time {
            font-size: 11px;
            opacity: 0.6;
        }

        .delete-btn {
            background: rgba(255, 67, 67, 0.3);
            border: none;
            color: #ff4343;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .delete-btn:hover {
            background: rgba(255, 67, 67, 0.5);
            transform: scale(1.1);
        }

        /* ========================================================= */
        /* MAIN WRAPPER */
        /* ========================================================= */
        .main-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* ========================================================= */
        /* HEADER */
        /* ========================================================= */
        .header {
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .header-controls {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
            color: white;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .header-btn:active {
            transform: scale(0.95);
        }

        /* ========================================================= */
        /* CHAT CONTAINER */
        /* ========================================================= */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* ========================================================= */
        /* CHAT AREA */
        /* ========================================================= */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .chat-area::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-window {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #welcome {
            text-align: center;
            margin: auto;
            color: white;
        }

        #welcome>div:first-child {
            font-size: 80px;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        #welcome h2 {
            font-size: 28px;
            margin: 8px 0;
            font-weight: 600;
        }

        #welcome p {
            opacity: 0.8;
            font-size: 16px;
        }

        /* ========================================================= */
        /* MESSAGE BUBBLES */
        /* ========================================================= */
        .msg {
            padding: 14px 16px;
            word-break: break-word;
            border-radius: 16px;
            animation: fadeMessage 0.3s ease;
            max-width: 70%;
        }

        @keyframes fadeMessage {
            0% {
                opacity: 0;
                transform: translateY(8px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .user-msg {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
        }

        .bot-msg {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .timestamp {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            color: inherit;
        }

        /* ========================================================= */
        /* BOT WRAPPER */
        /* ========================================================= */
        .bot-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .bot-avatar {
            width: 36px;
            height: 36px;
            background: var(--avatar-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            flex-shrink: 0;
            margin-top: 2px;
            box-shadow: 0 4px 12px rgba(77, 163, 255, 0.3);
        }

        /* ========================================================= */
        /* TYPING INDICATOR */
        /* ========================================================= */
        .typing {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 14px 16px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            width: fit-content;
            margin-right: auto;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out;
        }

        .dot:nth-child(2) {
            animation-delay: 0.15s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes pulse {

            0%,
            80%,
            100% {
                opacity: 0.4;
                transform: scale(0.8);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ========================================================= */
        /* CHAT BAR */
        /* ========================================================= */
        .chat-bar {
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        textarea {
            flex: 1;
            min-height: 48px;
            max-height: 160px;
            resize: none;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-family: inherit;
            font-size: 14px;
            overflow-y: auto;
            transition: all 0.2s ease;
        }

        textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .send-btn {
            padding: 0 22px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(123, 97, 255, 0.4);
        }

        .send-btn:active {
            transform: scale(0.98);
        }

        /* ========================================================= */
        /* FAQ SIDEBAR */
        /* ========================================================= */
        .faq-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            z-index: 50;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .faq-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .faq-sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .faq-sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .faq-title {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .faq-block {
            margin-bottom: 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        .faq-question {
            padding: 12px 14px;
            font-weight: 500;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            width: 100%;
            text-align: left;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .faq-question:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
        }

        .faq-answer {
            display: none;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.08);
            border-left: 3px solid var(--primary);
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            line-height: 1.5;
        }

        body.faq-closed .faq-sidebar {
            transform: translateX(100%);
        }

        body.faq-open .main-wrap {
            margin-right: 320px;
        }

        body.faq-closed .main-wrap {
            margin-right: 0;
        }

        /* ========================================================= */
        /* MODAL DIALOG */
        /* ========================================================= */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 30, 50, 0.9);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            text-align: center;
            color: white;
        }

        .modal-content h2 {
            margin: 0 0 12px 0;
            font-size: 20px;
        }

        .modal-content p {
            opacity: 0.8;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .modal-btn.confirm {
            background: #ff4343;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #ff5555;
            transform: scale(1.02);
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="faq-open">
    <div class="sidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon">üíº</div> <span>TaxBuddy</span>
        </div>
        <div class="menu-item"><b>üìä GST Expert</b><br><small>Rates, ITC, Filing</small></div>
        <div class="menu-item"><b>üí∞ Income Tax</b><br><small>Slabs, Deductions</small></div>
        <div class="sidebar-section-title">üìÑ Previous Chats</div>
        <div class="chats-container" id="chatsList">
            {% for chat in chats %}
            <div class="chat-item" id="chat-{{ chat.id }}">
                <div class="chat-item-content" onclick="loadChatFromHistory('{{ chat.id }}')">
                    <div class="chat-item-title">{{ chat.title }}</div>
                    <div class="chat-item-time">{{ chat.timestamp }}</div>
                </div>
                <button class="delete-btn" onclick="showDeleteModal(event, '{{ chat.id }}')"
                    title="Delete chat">üóëÔ∏è</button>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="main-wrap">
        <div class="header">
            <h2>TaxBuddy AI Assistant</h2>
            <div class="header-controls"> <button class="header-btn" id="themeBtn" title="Toggle Theme">üåô</button>
                <button class="header-btn" id="newChatBtn" title="New Chat">üÜï</button> <button class="header-btn"
                    id="faqToggleBtn" title="Toggle FAQ">‚ùì</button>
            </div>
        </div>
        <div class="chat-container"> <video id="bgVideo" autoplay loop muted
                style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2;">
                <source src="./../static/gst2.mp4" type="video/mp4">
            </video>
            <div class="chat-area" id="chatArea">
                <div id="welcome">
                    <div>üíº</div>
                    <h2>Welcome to TaxBuddy AI</h2>
                    <p>Your GST & Income Tax AI Assistant</p>
                </div>
                <div id="chatWindow" class="chat-window"></div>
            </div>
            <div class="chat-bar"> <input type="file" id="imageInput" accept="image/*" style="display:none;"> <button
                    id="uploadBtn" class="send-btn">üì∑</button> <textarea id="chatInput"
                    placeholder="Type your message..."></textarea> <button id="sendBtn" class="send-btn">Send</button>
            </div>
        </div>
    </div>
    <div id="faqSidebar" class="faq-sidebar">
        <h2 class="faq-title">üìò FAQ</h2>
        <div class="faq-block"> <button class="faq-question">üìä What is GST?</button>
            <div class="faq-answer"> GST is a unified indirect tax on supply of goods and services, replacing VAT,
                service tax, excise, etc. </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üßæ What are the types of GST?</button>
            <div class="faq-answer"> ‚Ä¢ CGST (Central)<br> ‚Ä¢ SGST (State)<br> ‚Ä¢ IGST (Inter-state)<br> ‚Ä¢ UTGST (Union
                Territory) </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üìÑ GST exempt goods & services?</button>
            <div class="faq-answer"> Exempt: Milk, bread, fruits, books, healthcare, education, public transport.<br>
                Zero-rated: Exports, SEZ units. </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üí∞ Basic exemption limit?</button>
            <div class="faq-answer"> ‚Ä¢ New Regime: ‚Çπ3,00,000<br> ‚Ä¢ Old Regime: ‚Çπ2,50,000 </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üè° Deductions allowed?</button>
            <div class="faq-answer"> 80C (LIC, ELSS, PF), 80D (medical insurance), 80G (donations), 24(b) (home loan
                interest). </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üìä Income Tax Slabs (New)</button>
            <div class="faq-answer"> 0‚Äì3 lakh ‚Üí 0%<br> 3‚Äì6 lakh ‚Üí 5%<br> 6‚Äì9 lakh ‚Üí 10%<br> 9‚Äì12 lakh ‚Üí 15%<br> 12‚Äì15
                lakh ‚Üí 20%<br> Above 15 lakh ‚Üí 30% </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üßæ Common TDS rates?</button>
            <div class="faq-answer"> Salary: As per slab<br> Professional fees: 10%<br> Rent: 10%<br> Contractor:
                1%/2%<br> Bank FD interest: 10% </div>
        </div>
        <div class="faq-block"> <button class="faq-question">üí° Tax Facts</button>
            <div class="faq-answer"> ‚Ä¢ Crypto tax is 30%.<br> ‚Ä¢ Gifts above ‚Çπ50,000 from non-relatives are taxable.<br>
                ‚Ä¢ New regime rebate makes income up to ‚Çπ7 lakh tax-free. </div>
        </div>
    </div> <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Chat?</h2>
            <p>This chat will be permanently deleted and cannot be recovered.</p>
            <div class="modal-buttons"> <button class="modal-btn cancel" id="cancelBtn">Cancel</button> <button
                    class="modal-btn confirm" id="confirmDeleteBtn">Delete</button> </div>
        </div>
    </div>
    <script>
        let currentCID = "{{ conversation_id }}";
        let chatToDelete = null;

        const chatArea = document.getElementById("chatArea");
        const chatWindow = document.getElementById("chatWindow");
        const chatInput = document.getElementById("chatInput");
        const welcome = document.getElementById("welcome");
        const deleteModal = document.getElementById("deleteModal");

        // ================= DELETE MODAL =================
        function showDeleteModal(event, cid) {
            event.stopPropagation();
            chatToDelete = cid;
            deleteModal.classList.add("show");
        }

        function hideDeleteModal() {
            chatToDelete = null;
            deleteModal.classList.remove("show");
        }

        document.getElementById("cancelBtn").onclick = hideDeleteModal;
        document.getElementById("confirmDeleteBtn").onclick = () => {
            if (chatToDelete) {
                deleteChat(chatToDelete);
            }
            hideDeleteModal();
        };

        // ================= UI HELPERS =================
        function showTyping() {
            let div = document.createElement("div");
            div.id = "typingIndicator";
            div.className = "typing";
            div.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
            chatWindow.appendChild(div);
            scrollSmooth();
        }

        function hideTyping() {
            let d = document.getElementById("typingIndicator");
            if (d) d.remove();
        }

        function scrollSmooth() {
            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: "smooth" });
        }

        function showChat() {
            welcome.style.display = "none";
        }

        function displayMessage(role, msg) {
            showChat();
            if (role === "bot" || role === "assistant") {
                let wrap = document.createElement("div");
                wrap.className = "bot-wrapper";
                let avatar = document.createElement("div");
                avatar.className = "bot-avatar";
                avatar.innerText = "ü§ñ";
                let bubble = document.createElement("div");
                bubble.className = "msg bot-msg";
                bubble.innerHTML = msg ? msg.replace(/\n/g, "<br>") : "";

                let time = document.createElement("div");
                time.className = "timestamp";
                time.innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                bubble.appendChild(time);

                wrap.appendChild(avatar);
                wrap.appendChild(bubble);
                chatWindow.appendChild(wrap);
                scrollSmooth();
                return;
            }
            // User message
            let div = document.createElement("div");
            div.className = "msg user-msg";
            div.innerText = msg;
            let t = document.createElement("div");
            t.className = "timestamp";
            t.innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.appendChild(t);
            chatWindow.appendChild(div);
            scrollSmooth();
        }

        // ================= ACTIONS =================
        async function loadChatFromHistory(cid) {
            currentCID = cid;
            chatWindow.innerHTML = "";
            showChat(); // Hide welcome

            try {
                let res = await fetch("/load_chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ conversation_id: cid })
                });
                let data = await res.json();
                if (data.history) {
                    data.history.forEach(m => displayMessage(m.role, m.content));
                }
            } catch (error) {
                console.error("Error loading chat:", error);
            }
        }

        async function sendMessage() {
            let text = chatInput.value.trim();
            if (!text) return;

            displayMessage("user", text);
            chatInput.value = "";
            chatInput.style.height = "auto";

            showTyping();

            try {
                let res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ conversation_id: currentCID, message: text })
                });

                hideTyping();
                let data = await res.json();
                displayMessage("assistant", data.reply);

            } catch (error) {
                hideTyping();
                displayMessage("assistant", "Sorry, I encountered an error. Please try again.");
                console.error("Error sending message:", error);
            }
        }

        async function deleteChat(cid) {
            try {
                await fetch("/delete_chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ conversation_id: cid })
                });

                // Remove from sidebar DOM
                let el = document.getElementById("chat-" + cid);
                if (el) el.remove();

                if (currentCID === cid) {
                    // Refresh to get a new session
                    window.location.reload();
                }
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        document.getElementById("newChatBtn").onclick = async () => {
            // Create new chat on server
            try {
                let res = await fetch("/new_chat", { method: "POST" });
                let data = await res.json();
                currentCID = data.conversation_id;
                chatWindow.innerHTML = "";
                welcome.style.display = "block";
                // Refresh page to see it in list? Or just continue.
                // Ideally we prepend to list, but for simplicity let's just start chatting.
                // The list updates on refresh.
            } catch (e) {
                console.error(e);
            }
        };

        // ================= EVENT LISTENERS =================
        document.getElementById("sendBtn").onclick = sendMessage;
        chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        chatInput.addEventListener("input", () => {
            chatInput.style.height = "auto";
            chatInput.style.height = Math.min(chatInput.scrollHeight, 160) + "px";
        });

        // Theme Toggle
        document.getElementById("themeBtn").onclick = () => {
            let t = document.body.getAttribute("data-theme");
            let newTheme = t === "light" ? "dark" : "light";
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("taxbuddy_theme", newTheme);
        };
        // Load saved theme
        let savedTheme = localStorage.getItem("taxbuddy_theme") || "light";
        document.body.setAttribute("data-theme", savedTheme);

        // Upload
        document.getElementById("uploadBtn").onclick = () => document.getElementById("imageInput").click();
        document.getElementById("imageInput").onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = function (evt) {
                let div = document.createElement("div");
                div.className = "msg user-msg";
                div.innerHTML = `<img src="${evt.target.result}" style="max-width:200px;border-radius:12px;">`;
                chatWindow.appendChild(div);
                scrollSmooth();
                showChat();
            };
            reader.readAsDataURL(file);

            showTyping();
            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("/upload-image", { method: "POST", body: formData });
                hideTyping();
                const data = await res.json();
                displayMessage("assistant", data.summary || "Image uploaded.");
            } catch (err) {
                hideTyping();
                displayMessage("assistant", "Error uploading image.");
            }
        };

        // FAQ Toggle
        document.getElementById("faqToggleBtn").onclick = () => {
            document.body.classList.toggle("faq-open");
            document.body.classList.toggle("faq-closed");
        };

        // FAQ Accordion
        document.querySelectorAll(".faq-question").forEach(q => {
            q.addEventListener("click", () => {
                let ans = q.nextElementSibling;
                let isOpen = ans.style.display === "block";
                document.querySelectorAll(".faq-answer").forEach(a => a.style.display = "none");
                if (!isOpen) ans.style.display = "block";
            });
        });

    </script>
</body>

</html>